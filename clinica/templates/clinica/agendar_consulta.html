{% extends 'clinica/base.html' %}

{% block content %}
<h1>Agendar Consulta</h1>
<form method="post">
    {% csrf_token %}
    {{ consulta_form.as_p }}
    <button type="submit" name="submit_consulta">Agendar</button>
</form>

<h2>Consultas Agendadas</h2>
<table border="1">
    <tr>
        <th>Cliente</th>
        <th>Doctor</th>
        <th>Fecha</th>
        <th>Estado</th>
        <th>Acciones</th>
        <th>Días Faltantes</th>
    </tr>
    {% for consulta in consultas %}
    <tr>
        <td>{{ consulta.cliente.nombre }}</td>
        <td>{{ consulta.doctor.nombre }}</td>
        <td>{{ consulta.fecha_hora|date:"d/m/Y H:i" }}</td>
        <td>{{ consulta.get_estado_asistencia_display }}</td>
        <td>
            {% if consulta.dias_faltantes < 0 %}
                Vencida ({{ consulta.dias_faltantes }} días)
            {% else %}
                Faltan {{ consulta.dias_faltantes }} días
            {% endif %}
        </td>
        <td>        
            {% if consulta.estado_asistencia == 'pendiente' %}
                <a href="{% url 'actualizar_asistencia' consulta.id 'asistio' %}">Marcar como Asistió</a> |
                <a href="{% url 'actualizar_asistencia' consulta.id 'no_asistio' %}">No asistió</a>
            {% else %}
                <em>Ya registrado</em>
            {% endif %}
        </td>
    </tr>
    {% empty %}
    <tr>
        <td colspan="5">No hay consultas registradas.</td>
    </tr>
    {% endfor %}
</table>

<h2>Efectividad general de asistencia</h2>
<p>
    Total de consultas: {{ total_consultas }} <br>
    Asistencias registradas: {{ asistidas }} <br>
    <strong>Efectividad: {{ efectividad }}%</strong>
</p>
{% endblock %}